"use strict";(self.webpackChunkppx_gatsby_blog=self.webpackChunkppx_gatsby_blog||[]).push([[433],{4784:function(e,n,t){t.r(n),t.d(n,{Head:function(){return u},default:function(){return h}});var r=t(6736),s=t(959);function a(e){const n=Object.assign({h2:"h2",p:"p",pre:"pre",code:"code",h4:"h4",h3:"h3"},(0,r.ah)(),e.components);return s.createElement(s.Fragment,null,s.createElement(n.h2,null,"Intro"),"\n",s.createElement(n.p,null,"Using Docker container to implement a PostgreSQL is not quite easy for a newcomer in Docker. Especially for those who are not familar with Database, it's very hard to configure and set everything correct. So that's why this artical is created. Let's start from a simple docker compose file."),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: test-postgres\n')),"\n",s.createElement(n.h2,null,"Docker compose's initialization"),"\n",s.createElement(n.p,null,"If you are not using a dockerfile to creating a Postgre image, instead, you are using docker compose file to directly a Postgre container, a lot of things will be done by the Docker itself. For example the ",s.createElement(n.code,null,"host name")," of the database is the ",s.createElement(n.code,null,"container_name")," you set for the db container."),"\n",s.createElement(n.h4,null,"User, password and Database"),"\n",s.createElement(n.p,null,"It will also generate a user using the password and database name you provided in the envrionment variables."),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: test-postgres\n    environment:\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=pass\n      - POSTGRES_DB=testdb\n')),"\n",s.createElement(n.h4,null,"Connection db"),"\n",s.createElement(n.p,null,"So when you are writing the backend code to connect the database, you can use these values for connection."),"\n",s.createElement(n.p,null,"A example with gorm in Golang is:"),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-go"},'import (\n        "gorm.io/driver/postgres"\n        "gorm.io/gorm"\n)\n\ndsn := "postgres://postgres:pass@test-postgres/testdb"\ndb, err = gorm.Open(postgres.Open(dsn), &gorm.Config{})\n')),"\n",s.createElement(n.h4,null,"Database initilization"),"\n",s.createElement(n.p,null,"To initilizate a database, you can use Docker volumes."),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: test-postgres\n    environment:\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=pass\n      - POSTGRES_DB=testdb\n    volumes:\n      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql\nvolumes:\n  postgres:\n')),"\n",s.createElement(n.p,null,"With this, init.sql will be run once the container starts."),"\n",s.createElement(n.p,null,"Notice: When the database container's data directory is empty, the initilization script/sql won't be run."),"\n",s.createElement(n.h4,null,"networks and ports"),"\n",s.createElement(n.p,null,"If you want to use container's name as the host name and provide another container from same or different networks the access to the postgres db, you need to setup network and ports."),"\n",s.createElement(n.p,null,"Using ",s.createElement(n.code,null,"networks"),", all containers in the same compose fill will be running under the same specified network, which allows to call host name directly."),"\n",s.createElement(n.p,null,"Using ",s.createElement(n.code,null,"ports"),", you can specify the outside port the postgres container. So when a service from different network trying to access the postgres db, it can use that port."),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: test-postgres\n    environment:\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=pass\n      - POSTGRES_DB=testdb\n    volumes:\n      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql\n    ports:\n      - 5432:5432\n    networks:\n      - test-network\nvolumes:\n  postgres:\n\nnetworks:\n  test-network:\n    name: test-network\n')),"\n",s.createElement(n.h2,null,"First come first served"),"\n",s.createElement(n.p,null,"Docker enables the dependency feature which allows you specify which service to run first and second. This is important because database's initialization may take time and is usually slower than the startup of backend services."),"\n",s.createElement(n.p,null,"However, the dependency only makes sure which services will run first, but Postgres container won't give a sign that the initialization is done. Docker compose will only know when database service is started successfully and will let it finish the remaining job, and start the next service."),"\n",s.createElement(n.p,null,"So usually when Docker starts the backend service, the init process isn't done, which will cause various errors such as ",s.createElement(n.code,null,"dial tcp [::1]:5432: connect: connection refused docker")," and ",s.createElement(n.code,null,'FATAL:  role "root" does not exist'),"."),"\n",s.createElement(n.p,null,"I chose ",s.createElement(n.code,null,"health check")," and ",s.createElement(n.code,null,"condition depend")," on in Docker to solve the problem."),"\n",s.createElement(n.h4,null,"Healthcheck"),"\n",s.createElement(n.p,null,"The healthcheck feature in Docker will check run some user defined commands and see if there is any error (exit code 1) returned depending on the timeout, intervals, and retries you set."),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: test-postgres\n    environment:\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=pass\n      - POSTGRES_DB=testdb\n    volumes:\n      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql\n    ports:\n      - 5432:5432\n    networks:\n      - test-network\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready -U postgres"]\n\nvolumes:\n  postgres:\n\nnetworks:\n  test-network:\n    name: test-network\n')),"\n",s.createElement(n.h4,null,"Conditional depends on"),"\n",s.createElement(n.p,null,"As I mentioned before the ",s.createElement(n.code,null,"depends on")," in Docker compose is not working well. However, we can add some condition to it and make it working with healthcheck."),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  backendserver:\n    build: "."\n    ports:\n      - "8080:8080"\n    depends_on:\n      postgres:\n        condition: service_healthy\n    network:\n      - test-network\n')),"\n",s.createElement(n.p,null,"It will run the health check command in the service ",s.createElement(n.code,null,"postgres")," and will only start this service if the condition is passed."),"\n",s.createElement(n.h2,null,"Some other points when configing Docker with Postgres"),"\n",s.createElement(n.p,null,"Some other things I may mention next time include ",s.createElement(n.code,null,"environment variables"),", other usage of volums and how to set correct interval, timeout and retires in healthcheck."),"\n",s.createElement(n.h2,null,"Appendix"),"\n",s.createElement(n.h3,null,"Full docker compose file"),"\n",s.createElement(n.pre,null,s.createElement(n.code,{className:"language-yaml"},'version: "3.6"\nservices:\n  postgres:\n    image: postgres:latest\n    container_name: test-postgres\n    environment:\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=pass\n      - POSTGRES_DB=testdb\n    volumes:\n      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql\n    ports:\n      - 5432:5432\n    networks:\n      - test-network\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready -U postgres"]\n\n  backendserver:\n    build: "."\n    ports:\n      - "8080:8080"\n    depends_on:\n      postgres:\n        condition: service_healthy\n    network:\n      - test-network\n\nvolumes:\n  postgres:\n\nnetworks:\n  test-network:\n    name: test-network\n')))}var o=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?s.createElement(n,e,s.createElement(a,e)):a(e)},l=t(9980),i=t(3090),c=t(5731),m=t(6564);const d={code:e=>{let{children:n,className:t}=e;return t?s.createElement(c.Z,{className:t},n):s.createElement("code",{className:"bg-bg-code-light dark:bg-bg-code-dark text-font-code-light dark:text-font-code-dark"},n)}},p=e=>{const{data:n,children:t}=e;if(!n.mdx||!n.mdx.frontmatter)return null;const a=n.mdx.frontmatter;return s.createElement(l.Z,{pageTitle:a.title},s.createElement("div",null,s.createElement("header",{className:"pt-6 xl:pb-6"},s.createElement("div",{className:"text-center space-y-1"},s.createElement("div",{className:"space-y-10"},s.createElement("div",null,s.createElement("p",{className:"text-base font-medium leading-6 text-teal-500"},a.date))),s.createElement("div",null,s.createElement("h1",{className:"text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14"},a.title)))),s.createElement("div",{className:"divide-y divide-gray-200 pb-7 dark:divide-gray-700 xl:divide-y-0"},s.createElement("div",{className:"divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"},s.createElement("div",{className:"prose max-w-none pb-8 pt-10 dark:prose-invert prose-lg prose-pre:p-0 prose-pre:m-0 prose-pre:bg-transparent"},s.createElement(r.Zo,{components:d},t))))),s.createElement(m.Z,null))},u=e=>{const{data:n,children:t}=e;if(!n.mdx||!n.mdx.frontmatter)return null;const r=n.mdx.frontmatter;return s.createElement(s.Fragment,null,s.createElement("html",{lang:"en"}),s.createElement("link",{rel:"stylesheet",href:"https://cdn.jsdelivr.net/npm/qweather-icons@1.4.0/font/qweather-icons.css"}),s.createElement(i.Z,{title:r.title,des:r.description}))};function h(e){return s.createElement(p,e,s.createElement(o,e))}}}]);
//# sourceMappingURL=component---src-pages-blog-mdx-frontmatter-query-id-tsx-content-file-path-blog-using-docker-with-postgres-index-mdx-04314fb37ff39c7c2ac7.js.map